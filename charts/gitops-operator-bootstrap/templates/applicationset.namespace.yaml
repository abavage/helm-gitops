apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  annotations:
    helm.sh/hook: pre-install
    helm.sh/hook-weight: "5"
  name: namespace
  namespace: openshift-gitops
spec:
  generators:
    - git:
        #repoURL: https://github.com/abavage/helm-gitops-cluster-config.git
        repoURL: {{ .Values.clusterConfigrepoURL }}
        revision: main
        files:
          #- path: "nonprod/one/namespaces/*/*.yaml"
          - path: "{{ .Values.namespaceGitPath }}/namespaces/*/*.yaml"
  template:
    metadata:
      name: 'namespace-{{ "{{ path.basenameNormalized }}" }}'
    spec:
      project: tenant-namespaces
      sources:
        #- repoURL: https://github.com/abavage/helm-gitops.git
        - repoURL: {{ .Values.repoURL }} 
          targetRevision: main
          path: charts/namespaces
          helm:
            valueFiles:
              #- $values/{{ path }}/{{ path.filename }}
              - $values/{{ "{{ path }}" }}/{{ "{{ path.filename }}" }}
        #- repoURL: https://github.com/abavage/helm-gitops-cluster-config.git
        - repoURL: {{ .Values.clusterConfigrepoURL }}
          targetRevision: main
          ref: values
      destination:
        server: https://kubernetes.default.svc
        namespace: openshift-gitops
      syncPolicy:
        automated:
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
          - ApplyOutOfSyncOnly=true
